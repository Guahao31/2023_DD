# 外设使用

本课程大程设计可使用多种外设来完成交互，如用来输入的键盘/鼠标、开关、按钮，用来输出的七段数码管、LED、VGA、蜂鸣器等。其中开关、LED、七段数码管的使用在小实验中已较为熟练，在此不进行详细说明，仅提供部分资源或链接。

## LED

Arduino 板上共有 8 个 LED，可直接使用 8 个信号控制亮灭，在 [Lab5](../lab5/decoder.md) 中第一次使用。

SWORD 板上有 16 个 LED，接收串行数据，由串行通信信号 `LED_sclk, LED_sclrn, LED_sout, LED_EN` 控制亮灭，其原理见 [LabD](../labD/shift_register.md/#onboard-LED-7seg)，这里提供 `LEDP2S` 的[网表文件](../lab9/attachment/LEDP2S.ngc)与[接口文件](../lab9/attachment/LEDP2S_io.v)，其约束请见任何小实验提供的约束中 `#16led` 注释部分。

## 七段数码管

Arduino 板上共有 4 个七段数码管，可使用使能信号 `AN` 进行扫描并用 `SEGMENT` 传入 8 位信号控制打印内容，在 [Lab7](../lab7/multiplexer.md) 中编写并使用。

SWORD 板上有 8 个七段数码管，接受串行数据，由串行通信信号 `seg_sclk, seg_sclrn, seg_sout, seg_EN` 控制，其原理见 [LabD](../labD/shift_register.md/#onboard-LED-7seg)，在 [Lab8](../lab8/ALU.md) 中第一次使用。

## 蜂鸣器

SWORD 板载 Arduino 板上有蜂鸣器，可用来发出简单的音效，其约束如下：

```
set_property PACKAGE_PIN AF25 [get_ports buzzer]
set_property IOSTANDARD LVCMOS33 [get_ports buzzer]
```

蜂鸣器接收一定频率的信号（如方波）并发出对应频率的声音，可以设计一个根据输入音高得到特定频率方波的模块来处理声音，它类似于：

```verilog
module buzzer_driver(
    input clk,
    input[4:0] note,
    output beep
)
```

模块内部，你可以根据输入的音高得到对应频率 `freq` 进而产生这一频率的方波 `beep`。

## VGA

本节参考 [blog](https://embeddedthoughts.com/2016/07/29/driving-a-vga-monitor-using-an-fpga/)，也可参考[知乎文章](https://zhuanlan.zhihu.com/p/359125055)。

VGA(Video Graphics Array) 协议是一种使用模拟信号的显示标准，我们需要提供的是数字信号（如比较重要的 RGB 三色值、扫描同步信号等），板内 DAC(Digital-to-Analog Converter, DAC/D2C) 会将其转换为 VGA 接口需要的模拟信号。

### 原理

在此讲解一些比较基本的 VGA 协议内容，如果想了解更多请查看本节参考资料或自行搜索。

影响画面质量的因素较主要的有分辨率、刷新率以及色彩。**分辨率**指屏幕中显示的有效像素点数量，一般以 `aaa × bbb` 表示，前者指一行中像素点个数，后者指一列中像素点个数。**刷新率**指屏幕内容刷新速度，一般以 Hz 为单位表示一秒钟刷新多少次。**色彩**主要指色彩空间格式与“精度”，VGA 要求使用 RGB 色彩空间（即红绿蓝三色混合）且为 12 位，即一个色彩通道用 4 位表示。在我们的实验中，使用 640×480@60Hz 的显示模式，需要接入的时钟频率为 25.175MHz。

我们使用**逐行扫描**的方式来打印界面，即每次图片刷新都从左上角开始，先从左到右扫描完一行，再转到下一行的最左边开始扫描，直到扫描完最后一行。我们需要处理**行时序**与**场时序**，时序图如下（时序图来自[知乎文章](https://zhuanlan.zhihu.com/p/87515249)）：

<img src="../pic/VGA-sync.png">

首先提供数据，对于 640×480@60Hz 的显示模式，上图中行扫描的 `a, b, c, d, e` 分别为 `96, 48, 640, 16, 800`，场扫描的 `o, p, q, r, s` 分别为 `2, 33, 480, 10, 525`。下面以行时序为例进行解释：行同步阶段(96)将行同步信号置于**低位**进行同步；显示后沿(48)将行同步信号重新拉起到**高位**但并不显示图像（将 RGB 三色通道均置为 0 即可）；有效数据(640)为每行 640 个像素点，此时将像素点对应的色彩 RGB 值放置在相应通道上进行色彩输出；显示前沿(16)不显示图像；之后将进入下一个周期的行扫描（从行同步开始）此时已经开始对下一行进行扫描，一次扫描经过的像素点数量(800)，但实际打印的有效数据数量(640)。场同步扫描与行同步扫描相似，不再赘述。

对于我们而言，只需要知道同步信号拉低与拉高的时机以及打印有效数据的时机即可（行坐标在 `[a+b, a+b+c)` 且列坐标在 `[o+p, o+p+q)` 时打印有效的数据）。

### 使用

这里提供一个可用的 VGA 驱动模块[代码](../attachment/vgac.v)，它来自老师提供的优秀工程。
